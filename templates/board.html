{% extends "base.html" %}

{% block content %}
<h1>Project {{ project.id }}: {{ project.name }}</h1>

<div style="display: flex; gap: 1em;">
    <div class="issue_details_sidebar" style="width: 22em;">
        <div>
            <strong>Created:</strong> {{ project.ctime|utc }}<br>
            <strong>Modified:</strong> {{ project.mtime|utc }}<br>
            <form method="post" action="/project/{{ project.id }}/column" style="margin-top: 0.2em; display: inline-block;">
                <input type="text" name="name" placeholder="Column name" required style="margin-right: 4px;">
                <input type="number" name="position" value="{{ board_data|length }}" min="-1" style="width: 60px; margin-right: 4px;">
                <input type="submit" value="Add">
            </form>
        </div>
    </div>
    <div style="flex: 1;">
        <div class="issue-list">
            <div class="header">
                <h3>Kanban</h3>
            </div>
            <div style="padding: 10px; background: white;">
                <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                    {% for item in board_data %}
                    <div class="column-container" data-column-id="{{ item.column.id }}" style="min-width: 250px; background: #f3f3f3; border: 1px solid lightgray; border-radius: 5px; padding: 10px;">
                        <h3 style="margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #93b7fa; padding-bottom: 5px;">{{ item.column.name }}</h3>
                        <div style="min-height: 100px;">
                            {% for issue in item.issues %}
                            <div class="issue-card" data-issue-id="{{ issue.id }}" style="background: white; border: 1px solid #ddd; border-radius: 3px; padding: 8px; margin-bottom: 5px; cursor: move;">
                                <div class="subject">
                                    <a href="/issue/{{ issue.id }}">{{ issue.title }}</a>
                                </div>
                                {% if issue.description %}
                                <div style="font-size: 0.9em; color: #777; margin-top: 5px;">{{ issue.description[:50] }}...</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <form method="post" action="/project/{{ project.id }}/issue" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                            <input type="hidden" name="column_id" value="{{ item.column.id }}">
                            <input type="text" name="title" placeholder="Add issue..." required style="width: 100%; padding: 5px; margin-bottom: 5px; border: 1px solid #ddd; box-sizing: border-box;">
                            <textarea name="description" placeholder="Description (optional)" style="width: 100%; padding: 5px; border: 1px solid #ddd; font-size: 12px; box-sizing: border-box;"></textarea>
                            <input type="submit" value="Add" style="margin-top: 5px; padding: 5px 10px;">
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="gantt" style="margin-top: 12px;">
            <div class="gantt-header">
                <h3>Gantt</h3>
                {% if min_ts and max_ts %}
                <div class="gantt-range">{{ min_ts|utc }} - {{ max_ts|utc }}</div>
                {% endif %}
            </div>
            {% if status_labels %}
            <div class="gantt-legend">
                {% for status_id, label in status_labels %}
                <span class="gantt-legend-item"><span class="gantt-legend-swatch status-{{ status_id }}"></span>{{ label }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if rows %}
            <div class="gantt-axis">
                <div class="gantt-axis-label">{{ min_ts|utc }}</div>
                <div class="gantt-axis-line">
                    {% for tick in ticks %}
                    <div class="gantt-tick" style="left: {{ tick.pct }}%;">
                        <span>{{ tick.ts|utc }}</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="gantt-axis-label gantt-axis-right">{{ max_ts|utc }}</div>
            </div>
            <div class="gantt-rows">
                {% for row in rows %}
                <div class="gantt-row">
                    <div class="gantt-label">
                        <div>
                            <a href="/issue/{{ row.issue.id }}">{{ row.issue.title }}</a>
                        </div>
                    </div>
                    <div class="gantt-bar-wrap">
                        {% if now_pct is not none %}
                        <div class="gantt-now" style="left: {{ now_pct }}%;" title="Now"></div>
                        {% endif %}
                        {% for seg in row.segments %}
                        <div class="gantt-seg status-{{ seg.status }}"
                             style="left: {{ seg.left_pct }}%; width: {{ seg.width_pct }}%;"
                             title="C {{ row.issue.ctime|utc }} | S {{ row.issue.stime|utc }} | E {{ row.issue.etime|utc }} | M {{ row.issue.mtime|utc }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="gantt-empty">No issues yet.</div>
            {% endif %}
        </div>
    </div>

</div>

<script src="/static/js/board.js"></script>
{% endblock %}
